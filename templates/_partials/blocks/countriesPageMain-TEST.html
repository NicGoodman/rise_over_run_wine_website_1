{% block main %}
  {% set countryName = entry.title %}

  {% set producerEntries = craft.entries().section('producers').all() %}

  {% set allWinesInCountry = craft.entries({
  section: 'wines',
  relatedTo: [
  'and',
  { targetElement: craft.entries().section('countries').title(countryName) }
  ]
  }).all() %}

{% set regions = [] %}
{% set subRegions = [] %}
{% for entry in allWinesInCountry %}

  {% if regiontag not in regions %}
    {% set regions = regions|merge([entry.regionsTag]) %}
  {% endif %}
  {% if subRegiontag not in subRegions %}
    {% set subRegions = subRegions|merge([entry.subRegionTag]) %}
  {% endif %}
{% endfor %}

{% for entry in producerEntries %}
    {% do entry.setFieldValue('regionsTag', regions) %}
    {% do entry.setFieldValue('subRegionTag', subRegions) %}

    {% do craft.app.getElements().saveElement(entry) %}
{% endfor %}





  <section id="country" {% if entry.heroImage|length %} {% set backgroundImage=entry.heroImage.one() %} class="w-screen min-h-screen flex flex-col pt-8 pb-8" style="background: linear-gradient(
      rgba(44, 55, 71, .5),
      rgba(44, 55, 71, .5)
    ), url('{{ backgroundImage.getUrl }}') center; background-size:cover;"
    {% else %} class="w-screen min-h-screen flex flex-col pt-8 bg-gray-800" {% endif %}>
    <h1 id="countryName" class="w-full mb-16 text-left text-5xl font-muli font-black uppercase text-riseoverrunwine-blue">{{ entry.title }}</h1>

  </section>

{% endblock %}
