{% block main %}

  {% set allRegionsQuery = craft.tags().group('regions') %}
  {% set allSubRegionsQuery = craft.tags().group('subRegions') %}
  {% set allWinesQuery = craft.entries().section('wines') %}
  {% set allProducersQuery = craft.entries().section('producers') %}

  {% set allRegion = allRegionQuery.all() %}
  {% set allSubRegions = allSubRegionsQuery.all() %}
  {% set allWines = allWinesQuery.all() %}
  {% set allProducers = allProducersQuery.all() %}

  {% set allProducersInCountry = allProducers.relatedTo(craft.entries().section('countries').title(entry.title)) %}
  {% set allRegionsInCountry = allRegions.relatedTo('allProducersInCountry') %}
  {% set allSubRegionsInCountry = allSubRegions.relatedTo('allProducersInCountry') %}
  {% set allWinesInCountry = allWines.relatedTo('allProducersInCountry') %}

  {% set winesWithNoRegion = allWines.regionsTag(':empty:') %}
  {% set producersWithWinesWithNoRegion = allProducersInCountry.relatedTo('winesWithNoRegion') %}

  <section id="country" {% if entry.heroImage|length %} {% set backgroundImage=entry.heroImage.one() %} class="w-screen min-h-screen flex flex-col pt-8 pl-16 pr-16 pb-8" style="background: linear-gradient(
      rgba(44, 55, 71, .5),
      rgba(44, 55, 71, .5)
    ), url('{{ backgroundImage.getUrl }}') center; background-size:cover;"
    {% else %} class="w-screen min-h-screen flex flex-col pt-8 pl-16 pr-16 bg-gray-800" {% endif %}>

    <h1 id="countryName" class="w-full mb-16 text-left text-5xl font-muli font-black uppercase text-riseoverrunwine-blue">{{ entry.title }}</h1>


  <section id="producersWtihNoRegion" class="flex flex-wrap w-full pt-4 pr-4">
    {% for entry in producersWithWinesWithNoRegion.all() %}
    {% set producerName = entry.title %}
    {% set producerWines = winesWithNoRegion.relatedTo('producerName') %}
    <section id="producer" class="flex flex-row w-1/2 pt-4 pr-4">
      <div id="producerImage" class="flex flex-col items-center w-1/3 ">
        {% if entry.producerImage|length %}
        {% set backgroundImage = entry.producerImage.one() %}
        <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue rounded-full border-2 border-riseoverrunwine-blue text-gray-100" style="background: linear-gradient(
            rgba(44, 55, 71, .5),
            rgba(44, 55, 71, .5)
          ), url('{{ backgroundImage.getUrl }}') center; background-size:cover;">
          <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
            {{ entry.title }}
          </h4>
        </div>
        {% else %}
        <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue text-gray-800 rounded-full border-2 border-gray-100">
          <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
            {{ entry.title }}
          </h4>
        </div>
        {% endif %}
      </div>
      <div id="producerInfo" class="w-2/3 mt-4">
        <h4 id="producerDescription" class="text-md font-light font-zilla text-gray-200 pb-4">
          {{ entry.producerDescription }}
        </h4>
        {% for entry in producerWines.all() %}
          <h5 id="wineName" class="text-lg font-medium font-zilla text-gray-200">
            {% if entry.wineType.value == 'red' %}
            <i class="fas fa-circle text-red-700"></i>
            {% endif %}
            {% if entry.wineType.value == 'white' %}
            <i class="fas fa-circle text-yellow-200"></i>
            {% endif %}
            {% if entry.wineType.value == 'rose' %}
            <i class="fas fa-circle text-red-200"></i>
            {% endif %}
            {% if entry.wineType.value == 'orange' %}
            <i class="fas fa-circle text-orange-300"></i>
            {% endif %}
            {% set wineName = entry.wineName ~ ' • '%}
            {% set grapeName = entry.grape ~ ' • '%}
            {{ wineName }}{{ grapeName }}{{ entry.vintage }}
          </h5>
        {% endfor %}
      </div>
    </section>
    {% endfor %}
  </section>


  {% for tag in allRegionsInCountry.all() %}

  {% set region = tag %}
  {% set winesInRegion = allWinesInCountry.relatedTo('region') %}
  {% set subRegions = allSubRegionsInCountry.relatedTo('winesInRegion') %}
  {% set winesInRegionWithNoSubRegion = winesInRegion.subRegionTag(':empty:') %}
  {% set winesInRegionWithSubRegion = winesInRegion.subRegionTag(':notempty:') %}
  <div id="region" class="flex flex-col w-full">
    <h2 id="regionName" class="w-full self-end text-3xl text-right text-gray-200 font-muli font-medium uppercase rounded-b-none border-b border-gray-200 mb-8">{{ region.title }}</h2>
    <section id="producersWtihNoSubRegion" class="flex flex-wrap w-full pt-4 pr-4">
    {% for entry in allProducersInCountry.relatedTo('winesInRegionWithNoSubRegion').all() %}

      {% set producerName = entry.title %}
      {% set producerWines = winesInRegionWithNoSubRegion.relatedTo('producerName')%}
      <section id="producer" class="flex flex-row w-1/2 pt-4 pr-4">
        <div id="producerImage" class="flex flex-col items-center w-1/3 ">
          {% if entry.producerImage|length %}
          {% set backgroundImage = entry.producerImage.one() %}
          <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue rounded-full border-2 border-riseoverrunwine-blue text-gray-100" style="background: linear-gradient(
              rgba(44, 55, 71, .5),
              rgba(44, 55, 71, .5)
            ), url('{{ backgroundImage.getUrl }}') center; background-size:cover;">
            <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
              {{ entry.title }}
            </h4>
          </div>
          {% else %}
          <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue text-gray-800 rounded-full border-2 border-gray-100">
            <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
              {{ entry.title }}
            </h4>
          </div>
          {% endif %}
        </div>
        <div id="producerInfo" class="w-2/3 mt-4">
          <h4 id="producerDescription" class="text-md font-light font-zilla text-gray-200 pb-4">
            {{ entry.producerDescription }}
          </h4>
          {% for entry in producerWines.all() %}
            <h5 id="wineName" class="text-lg font-medium font-zilla text-gray-200">
              {% if entry.wineType.value == 'red' %}
              <i class="fas fa-circle text-red-700"></i>
              {% endif %}
              {% if entry.wineType.value == 'white' %}
              <i class="fas fa-circle text-yellow-200"></i>
              {% endif %}
              {% if entry.wineType.value == 'rose' %}
              <i class="fas fa-circle text-red-200"></i>
              {% endif %}
              {% if entry.wineType.value == 'orange' %}
              <i class="fas fa-circle text-orange-300"></i>
              {% endif %}
              {% set wineName = entry.wineName ~ ' • '%}
              {% set grapeName = entry.grape ~ ' • '%}
              {{ wineName }}{{ grapeName }}{{ entry.vintage }}
            </h5>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
    </section>
    </div>
    <div id="subRegions" class="flex flex-row justify-end">
      {% for tag in subRegions.all() %}
        {% set subRegion = tag %}
        <section id="subRegion" class="flex flex-col w-1/2 p-4">
          <h3 id="subRegionName" class="w-full self-end text-lg text-right text-gray-200 font-muli font-bold uppercase border-b border-gray-500">{{ subRegion.title }}</h3>
          {% for entry in allProducersInCountry.relatedTo('subRegion').all() %}
            {% set producerName = entry.title %}
            {% set producerWines = winesInRegionWithSubRegion.relatedTo('producerName')%}
            <section id="producer" class="flex flex-row w-1/2 pt-4 pr-4">
              <div id="producerImage" class="flex flex-col items-center w-1/3 ">
                {% if entry.producerImage|length %}
                {% set backgroundImage = entry.producerImage.one() %}
                <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue rounded-full border-2 border-riseoverrunwine-blue text-gray-100" style="background: linear-gradient(
                    rgba(44, 55, 71, .5),
                    rgba(44, 55, 71, .5)
                  ), url('{{ backgroundImage.getUrl }}') center; background-size:cover;">
                  <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
                    {{ entry.title }}
                  </h4>
                </div>
                {% else %}
                <div class="flex flex-col justify-center w-40 h-40 pl-2 pr-2 mr-2 bg-riseoverrunwine-blue text-gray-800 rounded-full border-2 border-gray-100">
                  <h4 id="producerName" class="text-md text-center font-muli font-bold uppercase">
                    {{ entry.title }}
                  </h4>
                </div>
                {% endif %}
              </div>
              <div id="producerInfo" class="w-2/3 mt-4">
                <h4 id="producerDescription" class="text-md font-light font-zilla text-gray-200 pb-4">
                  {{ entry.producerDescription }}
                </h4>
                {% for entry in producerWines.all() %}
                  <h5 id="wineName" class="text-lg font-medium font-zilla text-gray-200">
                    {% if entry.wineType.value == 'red' %}
                    <i class="fas fa-circle text-red-700"></i>
                    {% endif %}
                    {% if entry.wineType.value == 'white' %}
                    <i class="fas fa-circle text-yellow-200"></i>
                    {% endif %}
                    {% if entry.wineType.value == 'rose' %}
                    <i class="fas fa-circle text-red-200"></i>
                    {% endif %}
                    {% if entry.wineType.value == 'orange' %}
                    <i class="fas fa-circle text-orange-300"></i>
                    {% endif %}
                    {% set wineName = entry.wineName ~ ' • '%}
                    {% set grapeName = entry.grape ~ ' • '%}
                    {{ wineName }}{{ grapeName }}{{ entry.vintage }}
                  </h5>
                {% endfor %}
              </div>
            </section>
          {% endfor %}
      {% endfor %}
    </div>
  {% endfor %}
  </section>
{% endblock %}
